<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Monev PPS (Versi Kompatibilitas)</title>
    
    <style>
        /* CSS Sederhana untuk Browser Kuno */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            color: #333;
            margin: 0;
            padding: 15px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border: 1px solid #ddd;
        }
        header {
            border-bottom: 1px solid #ccc;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        h1 {
            color: #333;
            margin: 0;
        }
        input[type="file"], button, select, textarea {
            font-size: 14px;
            padding: 8px 12px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #tabs-container button {
            background-color: #f2f2f2;
            color: #333;
            margin-right: 5px;
        }
        #tabs-container button.active {
            background-color: #007BFF;
            color: white;
        }
        #table-wrapper {
            overflow-x: auto;
            border: 1px solid #ddd;
            margin-top: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f2f2f2;
        }
        .ai-output {
            margin-top: 8px;
            padding: 8px;
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .ai-output-error {
            margin-top: 8px;
            padding: 8px;
            background-color: #fff1f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
        }
        .loader {
            display: inline-block;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            margin-right: 5px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading-external-scripts">
        <p>Memuat pustaka eksternal... Harap tunggu...</p>
    </div>
    
    <div id="main-app-content" class="container hidden">
        <header>
            <h1>Aplikasi Monev PPS</h1>
            <p>Unggah file XLSX Anda untuk memulai.</p>
            <button id="reset-app-btn" class="hidden" style="background-color: #888;">Mulai Ulang</button>
        </header>

        <div id="file-upload-container">
            <label for="file-upload">Unggah File Laporan (.xlsx):</label><br>
            <input type="file" id="file-upload" accept=".xlsx, .xls">
        </div>
        
        <div id="app-content" class="hidden">
            <div id="tabs-container"></div>
            <button id="download-table-btn" style="background-color: #008CBA;">Unduh Tabel (XLSX)</button>
            
            <div id="summary-container" class="hidden" style="margin-top: 20px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;"></div>
            <div id="diagnostic-box" class="hidden" style="margin-top: 15px; padding: 10px; background-color: #ffffe0; border: 1px solid #e6e6e0;"></div>

            <div id="table-wrapper">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Bab & EP</th>
                            <th>Uraian EP</th>
                            <th>Rekomendasi Surveyor</th>
                            <th>Kegiatan</th>
                            <th>Info Dokumen</th>
                            <th>Kecocokan</th>
                            <th>Status Kegiatan</th>
                            <th>Catatan Pembina</th>
                            <th>Feedback Pembina</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div id="initial-message">
            <p>Data dari file yang diunggah akan muncul di sini.</p>
        </div>
    </div>

    <!-- SCRIPT LIBRARY EKSTERNAL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.2.8/es6-promise.auto.min.js"></script>

    <!-- SCRIPT APLIKASI UTAMA (ES5 COMPATIBLE) -->
    <script>
        // Polyfill untuk Array.from jika tidak ada
        if (!Array.from) {
          Array.from = (function () {
            var toStr = Object.prototype.toString;
            var isCallable = function (fn) {
              return typeof fn === 'function' || toStr.call(fn) === '[object Function]';
            };
            var toInteger = function (value) {
              var number = Number(value);
              if (isNaN(number)) { return 0; }
              if (number === 0 || !isFinite(number)) { return number; }
              return (number > 0 ? 1 : -1) * Math.floor(Math.abs(number));
            };
            var maxSafeInteger = Math.pow(2, 53) - 1;
            var toLength = function (value) {
              var len = toInteger(value);
              return Math.min(Math.max(len, 0), maxSafeInteger);
            };
            return function from(arrayLike/*, mapFn, thisArg */) {
              var C = this;
              var items = Object(arrayLike);
              if (arrayLike == null) {
                throw new TypeError("Array.from requires an array-like object - not null or undefined");
              }
              var mapFn = arguments.length > 1 ? arguments[1] : void undefined;
              var T;
              if (typeof mapFn !== 'undefined') {
                if (!isCallable(mapFn)) {
                  throw new TypeError('Array.from: when provided, the second argument must be a function');
                }
                if (arguments.length > 2) {
                  T = arguments[2];
                }
              }
              var len = toLength(items.length);
              var A = isCallable(C) ? Object(new C(len)) : new Array(len);
              var k = 0;
              var kValue;
              while (k < len) {
                kValue = items[k];
                if (mapFn) {
                  A[k] = typeof T === 'undefined' ? mapFn(kValue, k) : mapFn.call(T, kValue, k);
                } else {
                  A[k] = kValue;
                }
                k += 1;
              }
              A.length = len;
              return A;
            };
          }());
        }

        // Variabel global
        var fullData = [];
        var aiCache = {}; // Menggunakan object biasa, bukan Map
        var MAX_RETRIES = 3;
        var MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        var apiKey = ""; 

        var fileUpload, fileUploadContainer, resetAppBtn;
        var appContent, tabsContainer, dataTableBody, tableWrapper, diagnosticBox, initialMessage, summaryContainer, downloadTableBtn;

        function initApp() {
            fileUpload = document.getElementById('file-upload');
            fileUploadContainer = document.getElementById('file-upload-container');
            resetAppBtn = document.getElementById('reset-app-btn');
            appContent = document.getElementById('app-content');
            tabsContainer = document.getElementById('tabs-container');
            dataTableBody = document.querySelector('#data-table tbody');
            tableWrapper = document.getElementById('table-wrapper');
            diagnosticBox = document.getElementById('diagnostic-box');
            initialMessage = document.getElementById('initial-message'); 
            summaryContainer = document.getElementById('summary-container');
            downloadTableBtn = document.getElementById('download-table-btn');

            tableWrapper.style.display = 'none';

            fileUpload.addEventListener('change', handleFile, false);
            downloadTableBtn.addEventListener('click', downloadTableAsXLSX);
            resetAppBtn.addEventListener('click', resetApp);
            
            document.getElementById('loading-external-scripts').className = 'hidden';
            document.getElementById('main-app-content').className = 'container';
        }

        function resetApp() {
            fullData = [];
            aiCache = {};
            dataTableBody.innerHTML = '';
            tabsContainer.innerHTML = '';
            summaryContainer.className = 'hidden';
            summaryContainer.innerHTML = '';
            diagnosticBox.className = 'hidden';
            diagnosticBox.innerHTML = '';
            tableWrapper.style.display = 'none';
            initialMessage.style.display = 'block';
            appContent.className = 'hidden';
            fileUpload.value = '';
            resetAppBtn.className = 'hidden';
        }

        function callGeminiApi(systemPrompt, userQuery) {
            var apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/" + MODEL_NAME + ":generateContent?key=" + apiKey;
            var payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            return new Promise(function(resolve, reject) {
                var attempt = function(retries) {
                    fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(function(response) {
                        if (!response.ok) {
                            return response.json().then(function(err) {
                                throw new Error("Status " + response.status + ": " + (err.error ? err.error.message : 'Unknown Error'));
                            });
                        }
                        return response.json();
                    })
                    .then(function(result) {
                        var text = (result.candidates && result.candidates[0] && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts[0].text) || "Gagal mendapatkan respons.";
                        resolve(text);
                    })
                    .catch(function(error) {
                        console.error("Gemini API Error:", error);
                        if (retries > 0) {
                            setTimeout(function() { attempt(retries - 1); }, 1000 * Math.pow(2, MAX_RETRIES - retries));
                        } else {
                            resolve("Kesalahan API: " + error.message + ". Coba lagi nanti.");
                        }
                    });
                };
                attempt(MAX_RETRIES);
            });
        }

        function handleFile(e) {
            var file = e.target.files[0];
            var reader = new FileReader();
            reader.onload = function(event) {
                var data = new Uint8Array(event.target.result);
                var workbook = XLSX.read(data, { type: 'array' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processData(jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        // Fungsi lainnya diubah ke ES5
        function isRowEmpty(row) {
            if (!row) return true;
            return row.every(function(cell) { return !cell || String(cell).trim() === ''; });
        }

        function processData(jsonData) {
            if (jsonData.length === 0) {
                initialMessage.innerHTML = '<p style="color:red;">File kosong.</p>'; return;
            }
            var headerIndex = -1;
            for (var i = 0; i < jsonData.length; i++) {
                if (!isRowEmpty(jsonData[i])) { headerIndex = i; break; }
            }
            if (headerIndex === -1) {
                initialMessage.innerHTML = '<p style="color:red;">Header tidak ditemukan.</p>'; return;
            }
            var header = jsonData[headerIndex];
            var rows = jsonData.slice(headerIndex + 1);
            var diagnosticHtml = '<p>Peta Kolom (Baris ' + (headerIndex + 1) + '):</p><ul>';
            var headerMapping = {};
            if (header) {
                header.forEach(function(cell, i) {
                    var cleanCell = String(cell || '').toLowerCase().trim().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                    var keyFound = null;
                    if (cleanCell.startsWith('no')) keyFound = 'no';
                    else if (cleanCell.indexOf('bab') > -1 && cleanCell.indexOf('uraian') === -1) keyFound = 'bab_ep';
                    else if (cleanCell.indexOf('uraian') > -1 || cleanCell.indexOf('elemen_penilaian') > -1) keyFound = 'uraian_ep';
                    else if (cleanCell.indexOf('rekomendasi') > -1 || cleanCell.indexOf('surveyor') > -1) keyFound = 'rekomendasi_surveyor';
                    else if (cleanCell.indexOf('kegiatan') > -1 && cleanCell.indexOf('status') === -1) keyFound = 'kegiatan';
                    else if (cleanCell.indexOf('status_kegiatan') > -1) keyFound = 'status_kegiatan';
                    else if (cleanCell.indexOf('catatan_pembina') > -1) keyFound = 'catatan_pembina';
                    if (keyFound) {
                        if (headerMapping[keyFound] === undefined) headerMapping[keyFound] = i;
                        diagnosticHtml += '<li><strong>' + keyFound.toUpperCase() + '</strong> &rarr; Index ' + i + ' ("' + cell + '")</li>';
                    } else {
                        diagnosticHtml += '<li style="color:red;">Index ' + i + ' ("' + cell + '") tidak dikenali.</li>';
                    }
                });
            }
            diagnosticHtml += '</ul>';
            
            var noIndex = headerMapping.no !== undefined ? headerMapping.no : 0;
            var babEpIndex = headerMapping.bab_ep !== undefined ? headerMapping.bab_ep : 1;
            var uraianEpIndex = headerMapping.uraian_ep !== undefined ? headerMapping.uraian_ep : 2;
            var rekomIndex = headerMapping.rekomendasi_surveyor !== undefined ? headerMapping.rekomendasi_surveyor : 3;
            var kegiatanIndex = headerMapping.kegiatan !== undefined ? headerMapping.kegiatan : 4;
            var statusIndex = headerMapping.status_kegiatan !== undefined ? headerMapping.status_kegiatan : 7;
            var catatanIndex = headerMapping.catatan_pembina !== undefined ? headerMapping.catatan_pembina : 8;

            var lastValidNo = '';
            var initialId = 0;
            fullData = rows.map(function(row) {
                var currentNo = row[noIndex] ? String(row[noIndex]).trim() : '';
                var bab_ep = row[babEpIndex] ? String(row[babEpIndex]).trim() : '';
                var uraian_ep = row[uraianEpIndex] ? String(row[uraianEpIndex]).trim() : '';
                var rekomendasi_surveyor = row[rekomIndex] ? String(row[rekomIndex]).trim() : '';
                var kegiatan = row[kegiatanIndex] ? String(row[kegiatanIndex]).trim() : '';
                if (isRowEmpty([currentNo, bab_ep, uraian_ep, rekomendasi_surveyor, kegiatan])) return null;
                if (currentNo) lastValidNo = currentNo; else currentNo = lastValidNo;
                if (!currentNo) return null;
                return {
                    id: initialId++, no: currentNo, bab_ep: bab_ep, uraian_ep: uraian_ep,
                    rekomendasi_surveyor: rekomendasi_surveyor, kegiatan: kegiatan,
                    status_kegiatan: row[statusIndex] || '', catatan_pembina: row[catatanIndex] || '',
                    ai_info_doc: '', ai_analisa: '', ai_feedback: '', kecocokan_manual: ''
                };
            }).filter(function(item) { return item !== null; });

            if (fullData.length > 0) {
                appContent.className = ''; resetAppBtn.className = '';
                tableWrapper.style.display = 'block'; initialMessage.style.display = 'none';
                diagnosticBox.className = ''; diagnosticBox.innerHTML = diagnosticHtml;
                createTabs(); renderTable(fullData);
            } else {
                initialMessage.innerHTML = '<p style="color:red;">Gagal memproses data.</p>';
            }
        }
        
        function createTabs() {
            tabsContainer.innerHTML = '';
            summaryContainer.className = 'hidden';
            var babColumnKey = 'bab_ep';
            if (!fullData[0] || !fullData[0][babColumnKey]) return;
            
            var babSet = {};
            fullData.forEach(function(item) {
                var babInfo = (item[babColumnKey] || '').toString();
                var match = babInfo.match(/Bab\s*([IVXLCDM\d]+)/i);
                if (match) babSet['BAB ' + match[1].toUpperCase()] = true;
            });
            var babs = Object.keys(babSet);

            var allButton = document.createElement('button');
            allButton.textContent = 'Semua Bab';
            allButton.className = 'active';
            allButton.onclick = function() {
                renderTable(fullData);
                summaryContainer.className = 'hidden';
                var buttons = document.querySelectorAll('#tabs-container button');
                for (var i = 0; i < buttons.length; i++) buttons[i].className = '';
                allButton.className = 'active';
            };
            tabsContainer.appendChild(allButton);

            babs.forEach(function(bab) {
                var button = document.createElement('button');
                button.textContent = bab;
                button.onclick = function() {
                    var filteredData = fullData.filter(function(item) {
                        return (item[babColumnKey] || '').toString().toUpperCase().indexOf(bab) === 0;
                    });
                    renderTable(filteredData);
                    showBabSummaryUI(bab);
                    var buttons = document.querySelectorAll('#tabs-container button');
                    for (var i = 0; i < buttons.length; i++) buttons[i].className = '';
                    button.className = 'active';
                };
                tabsContainer.appendChild(button);
            });
        }
        
        function renderTable(data) {
            dataTableBody.innerHTML = '';
            data.forEach(function(row) {
                var tr = document.createElement('tr');
                tr.id = 'row-' + row.id;
                var status = (row.status_kegiatan || '').toLowerCase();
                var statusOptions = '<option value="">Pilih Status</option>' +
                    '<option value="belum" ' + (status.indexOf('belum') > -1 ? 'selected' : '') + '>Belum dilaksanakan</option>' +
                    '<option value="proses" ' + (status.indexOf('proses') > -1 ? 'selected' : '') + '>Dalam Proses</option>' +
                    '<option value="selesai" ' + (status.indexOf('selesai') > -1 || status.indexOf('sudah') > -1 ? 'selected' : '') + '>Selesai</option>';

                var kecocokanOptions = '<option value="">Pilih</option>' +
                    '<option value="cocok" ' + (row.kecocokan_manual === 'cocok' ? 'selected' : '') + '>Cocok</option>' +
                    '<option value="kurang" ' + (row.kecocokan_manual === 'kurang' ? 'selected' : '') + '>Kurang Cocok</option>' +
                    '<option value="tidak" ' + (row.kecocokan_manual === 'tidak' ? 'selected' : '') + '>Tidak Cocok</option>';

                tr.innerHTML = '<td>' + (row.no || '') + '</td>' +
                    '<td>' + (row.bab_ep || '').replace(/\n/g, '<br>') + '</td>' +
                    '<td>' + (row.uraian_ep || '') + '</td>' +
                    '<td>' + (row.rekomendasi_surveyor || '') + '</td>' +
                    '<td>' + (row.kegiatan || '') + '</td>' +
                    '<td id="info-' + row.id + '">' +
                    '<button onclick="generateAiResponse(\'' + row.id + '\', \'info\')">Info Dokumen</button>' +
                    (row.ai_info_doc ? '<div class="ai-output">' + row.ai_info_doc + '</div>' : '') +
                    '</td>' +
                    '<td id="analisa-' + row.id + '">' +
                    '<button onclick="generateAiResponse(\'' + row.id + '\', \'analisa\')" style="background-color:#f97316;">Analisa</button>' +
                    (row.ai_analisa ? '<div class="ai-output">' + row.ai_analisa + '</div>' : '') +
                    '<div style="margin-top:5px;"><select onchange="updateRowData(\'' + row.id + '\', \'kecocokan_manual\', this.value)">' + kecocokanOptions + '</select></div>' +
                    '</td>' +
                    '<td><select onchange="updateRowData(\'' + row.id + '\', \'status_kegiatan\', this.value)">' + statusOptions + '</select></td>' +
                    '<td><textarea oninput="updateRowData(\'' + row.id + '\', \'catatan_pembina\', this.value)" rows="3">' + (row.catatan_pembina || '') + '</textarea></td>' +
                    '<td id="feedback-' + row.id + '">' +
                    '<button onclick="generateAiResponse(\'' + row.id + '\', \'feedback\')" style="background-color:#8b5cf6;">Feedback</button>' +
                    (row.ai_feedback ? '<div class="ai-output">' + row.ai_feedback + '</div>' : '') +
                    '</td>';
                dataTableBody.appendChild(tr);
            });
        }
        
        function updateRowData(rowId, key, value) {
            for (var i = 0; i < fullData.length; i++) {
                if (fullData[i].id == rowId) {
                    fullData[i][key] = value;
                    break;
                }
            }
        }
        
        function getMockInfoDoc(uraianEp, rekomendasi, kegiatan) {
            var uraian = (uraianEp || '').toLowerCase();
            var suggestions = [];
            if (uraian.indexOf('kebijakan') > -1) suggestions.push('<li>Wajib verifikasi: <strong>SK Kepala/Pimpinan</strong>.</li>');
            if (uraian.indexOf('sop') > -1 || uraian.indexOf('prosedur') > -1) suggestions.push('<li>Wajib verifikasi: <strong>SOP/Panduan</strong>.</li>');
            if (uraian.indexOf('pelatihan') > -1 || uraian.indexOf('sosialisasi') > -1) suggestions.push('<li>Dokumen: <strong>Undangan, Daftar Hadir, Materi</strong>.</li>');
            if (suggestions.length === 0) suggestions.push('<li>Periksa <strong>dokumentasi/foto</strong> pelaksanaan.</li>');
            return '<p>Dokumen relevan:</p><ul>' + suggestions.join('') + '</ul>';
        }

        function generateAiResponse(rowId, type) {
            var rowData;
            for (var i = 0; i < fullData.length; i++) { if (fullData[i].id == rowId) { rowData = fullData[i]; break; } }
            if (!rowData) return;

            var targetCell = document.getElementById(type + '-' + rowId);
            var button = targetCell.querySelector('button');
            var cacheKey = rowId + '-' + type;

            if (aiCache[cacheKey]) {
                targetCell.innerHTML = aiCache[cacheKey];
                return;
            }

            if (type === 'info') {
                var mockOutput = getMockInfoDoc(rowData.uraian_ep, rowData.rekomendasi_surveyor, rowData.kegiatan);
                var htmlOutput = button.outerHTML + '<div class="ai-output">' + mockOutput + '</div>';
                rowData.ai_info_doc = mockOutput;
                aiCache[cacheKey] = htmlOutput;
                targetCell.innerHTML = htmlOutput;
                return;
            }

            var originalButtonHtml = button.outerHTML;
            var selectElement = targetCell.querySelector('select');
            button.disabled = true;
            button.innerHTML = '<span class="loader"></span> Menganalisis...';

            var systemPrompt = '';
            var userQuery = '';
            var outputKey = '';

            if (type === 'analisa') {
                outputKey = 'ai_analisa';
                systemPrompt = 'Anda adalah Auditor Akreditasi. Bandingkan "Kegiatan" dengan "Rekomendasi". Beri analisis singkat dalam format: ANALISIS SINGKAT: [Teks], TINGKAT KECOCOKAN: [Cocok/Kurang Cocok/Tidak Cocok], SARAN: [Teks].';
                userQuery = 'Rekomendasi: ' + rowData.rekomendasi_surveyor + '\nKegiatan: ' + rowData.kegiatan;
            } else if (type === 'feedback') {
                outputKey = 'ai_feedback';
                systemPrompt = 'Anda adalah Pembina Monev. Berikan feedback singkat (maks 50 kata) berdasarkan data berikut.';
                userQuery = 'Rekomendasi: ' + rowData.rekomendasi_surveyor + '\nKegiatan: ' + rowData.kegiatan + '\nCatatan: ' + (rowData.catatan_pembina || 'N/A');
            }

            callGeminiApi(systemPrompt, userQuery).then(function(aiText) {
                rowData[outputKey] = aiText;
                var htmlOutput;
                if (aiText.toLowerCase().indexOf('error') === 0 || aiText.toLowerCase().indexOf('kesalahan') === 0) {
                    htmlOutput = originalButtonHtml + '<div class="ai-output-error">' + aiText + '</div>';
                } else {
                    htmlOutput = originalButtonHtml + '<div class="ai-output">' + aiText + '</div>';
                }

                if (type === 'analisa') {
                    if (selectElement) {
                         var match = aiText.match(/TINGKAT KECOCOKAN:\s*(Cocok|Kurang Cocok|Tidak Cocok)/i);
                         if (match && match[1]) {
                             var val = match[1].toLowerCase().replace(' ', '');
                             if(val === 'kurangcocok') val = 'kurang';
                             if(val === 'tidakcocok') val = 'tidak';
                             selectElement.value = val;
                             updateRowData(rowId, 'kecocokan_manual', val);
                         }
                        htmlOutput += '<div style="margin-top:5px;">' + selectElement.outerHTML + '</div>';
                    }
                }
                aiCache[cacheKey] = htmlOutput;
                targetCell.innerHTML = htmlOutput;
            });
        }
        
        // Fungsi generateBabSummary dan downloaders akan terlalu kompleks untuk di-polyfill dengan andal.
        // Untuk versi kompatibilitas, kita sederhanakan dengan menghilangkan fitur-fitur ini.
        function showBabSummaryUI(babName) {
            summaryContainer.className = '';
            summaryContainer.innerHTML = '<h3>Rekapitulasi untuk ' + babName + '</h3>' +
                '<p>Fitur rekapitulasi otomatis tidak didukung di browser versi lama. Silakan unduh sebagai Excel untuk analisis manual.</p>';
        }

        function downloadTableAsXLSX() {
            var btn = document.getElementById('download-table-btn');
            btn.innerHTML = '<span class="loader"></span> Menyiapkan...';
            btn.disabled = true;

            setTimeout(function() {
                var dataToExport = [];
                var headers = ["No", "Bab & EP", "Uraian EP", "Rekomendasi Surveyor", "Kegiatan", "Info Dokumen", "Analisa Kecocokan", "Pilihan Manual", "Status", "Catatan Pembina", "Feedback AI"];
                
                fullData.forEach(function(row) {
                    var rowData = {};
                    rowData[headers[0]] = row.no;
                    rowData[headers[1]] = row.bab_ep;
                    rowData[headers[2]] = row.uraian_ep;
                    rowData[headers[3]] = row.rekomendasi_surveyor;
                    rowData[headers[4]] = row.kegiatan;
                    rowData[headers[5]] = (row.ai_info_doc || '').replace(/<[^>]*>?/gm, '');
                    rowData[headers[6]] = (row.ai_analisa || '').replace(/<[^>]*>?/gm, '');
                    rowData[headers[7]] = row.kecocokan_manual;
                    rowData[headers[8]] = row.status_kegiatan;
                    rowData[headers[9]] = row.catatan_pembina;
                    rowData[headers[10]] = (row.ai_feedback || '').replace(/<[^>]*>?/gm, '');
                    dataToExport.push(rowData);
                });

                var worksheet = XLSX.utils.json_to_sheet(dataToExport, { header: headers });
                var workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Laporan Monev");
                XLSX.writeFile(workbook, "Laporan_Monev_Kompatibel.xlsx");

                btn.innerHTML = 'Unduh Tabel (XLSX)';
                btn.disabled = false;
            }, 500);
        }

        // Jalankan aplikasi setelah halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            // Kita panggil initApp langsung karena script pustaka sudah di-load secara sinkron di atas
            initApp();
        });

    </script>

</body>
</html>

